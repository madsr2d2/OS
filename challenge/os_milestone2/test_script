#!/bin/bash

usage() {
    echo "Usage: ./test_script <client_arg_number> <start> <stop> <number of steps> <server_port_1> [server_port_2]"
    exit 1
}

run_client() {
    local port=$1
    local arg_value=$2
    CLIENT_ARGS="localhost $port 1 100 0 100 0 0 0"
    CLIENT_ARGS=$(echo "$CLIENT_ARGS" | awk -v num="$ARG_NUMBER" -v value="$arg_value" '{$num=value; print}')
    ./client $CLIENT_ARGS | tail -n 1
}

calculate_stats() {
    local data=("$@")
    local length=${#data[@]}
    local sum=0
    local sumsq=0
    for val in "${data[@]}"; do
        sum=$(bc <<< "$sum + $val")
        sumsq=$(bc <<< "$sumsq + $val * $val")
    done
    local avg=$(bc <<< "scale=2; $sum / $length")
    local variance=$(bc <<< "scale=2; ($sumsq - ($sum * $sum / $length)) / ($length - 1)")
    local sd=$(bc <<< "scale=2; sqrt($variance)")
    echo $avg $sd
}

# Argument Validation
if [ "$#" -lt 5 ]; then
    usage
fi

ARG_NUMBER=$1
ARG_START=$2
ARG_STOP=$3
STEPS=$4
SERVER_PORT1=$5
SERVER_PORT2=$6
STEP=$(( ($ARG_STOP - $ARG_START) / ($STEPS - 1) ))

for (( i=0; i<$STEPS; i++ )); do
    ARG_VALUE=$(( ARG_START + i*STEP ))
    VAL1_1_RUNS=()
    VAL2_1_RUNS=()
    VAL1_2_RUNS=()
    VAL2_2_RUNS=()

    for (( run=1; run<=10; run++ )); do
        IFS=' ' read -ra RESULT1 <<< "$(run_client "$SERVER_PORT1" "$ARG_VALUE")"
        VAL1_1_RUNS+=("${RESULT1[1]}")
        VAL2_1_RUNS+=("${RESULT1[2]}")

        if [ ! -z "$SERVER_PORT2" ]; then
            IFS=' ' read -ra RESULT2 <<< "$(run_client "$SERVER_PORT2" "$ARG_VALUE")"
            VAL1_2_RUNS+=("${RESULT2[1]}")
            VAL2_2_RUNS+=("${RESULT2[2]}")
        fi
    done

    IFS=' ' read -ra STATS1_1 <<< "$(calculate_stats "${VAL1_1_RUNS[@]}")"
    IFS=' ' read -ra STATS2_1 <<< "$(calculate_stats "${VAL2_1_RUNS[@]}")"

    if [ ! -z "$SERVER_PORT2" ]; then
        IFS=' ' read -ra STATS1_2 <<< "$(calculate_stats "${VAL1_2_RUNS[@]}")"
        IFS=' ' read -ra STATS2_2 <<< "$(calculate_stats "${VAL2_2_RUNS[@]}")"

        AVG_DIFF1=$(bc <<< "${STATS1_1[0]} - ${STATS1_2[0]}")
        AVG_DIFF2=$(bc <<< "${STATS2_1[0]} - ${STATS2_2[0]}")

        SD_DIFF1=$(bc <<< "sqrt(${STATS1_1[1]}^2 + ${STATS1_2[1]}^2)")
        SD_DIFF2=$(bc <<< "sqrt(${STATS2_1[1]}^2 + ${STATS2_2[1]}^2)")

        echo -n "Run $((i+1)) (Server on port $SERVER_PORT1 - Server on port $SERVER_PORT2): $ARG_VALUE  Results: "
        printf "%.1f ± %.1f %.1f ± %.1f\n" $AVG_DIFF1 $SD_DIFF1 $AVG_DIFF2 $SD_DIFF2
    else
        echo -n "Server on port $SERVER_PORT1, Run $((i+1)): $ARG_VALUE  Results: "
        printf "%.1f ± %.1f %.1f ± %.1f\n" "${STATS1_1[0]}" "${STATS1_1[1]}" "${STATS2_1[0]}" "${STATS2_1[1]}"
    fi
done
